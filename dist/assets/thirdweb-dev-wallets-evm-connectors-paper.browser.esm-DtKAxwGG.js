import{cK as p,cL as R,cM as k,c7 as b,cN as j,C as q,_ as g,w as Q,c as z,n as x,f as H}from"./index-CRXhB-tn.js";var F=Object.defineProperty,$=Object.defineProperties,V=Object.getOwnPropertyDescriptors,O=Object.getOwnPropertySymbols,K=Object.prototype.hasOwnProperty,B=Object.prototype.propertyIsEnumerable,D=(e,t,i)=>t in e?F(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,h=(e,t)=>{for(var i in t||(t={}))K.call(t,i)&&D(e,i,t[i]);if(O)for(var i of O(t))B.call(t,i)&&D(e,i,t[i]);return e},f=(e,t)=>$(e,V(t)),n=(e,t,i)=>new Promise((r,s)=>{var a=l=>{try{c(i.next(l))}catch(d){s(d)}},o=l=>{try{c(i.throw(l))}catch(d){s(d)}},c=l=>l.done?r(l.value):Promise.resolve(l.value).then(a,o);c((i=i.apply(e,t)).next())}),A="/sdk/2022-08-12/embedded-wallet",I=e=>`paperEwsWalletUserId-${e}`,J="walletToken",w=e=>`${J}-${e}`,Z="a",y=(e,t)=>`${Z}-${e}-${t}`,L=(e=>(e.USER_MANAGED="USER_MANAGED",e.AWS_MANAGED="AWS_MANAGED",e))(L||{}),N=(e=>(e.PAPER_EMAIL_OTP="PaperEmailOTP",e.GOOGLE="Google",e.TWITTER="Twitter",e.COGNITO="Cognito",e.AUTH0="Auth0",e.CUSTOM_JWT="CustomJWT",e))(N||{}),m=(e=>(e.LOGGED_OUT="Logged Out",e.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",e))(m||{}),P=(e=>(e.LOGGED_OUT="Logged Out",e.LOGGED_IN_WALLET_UNINITIALIZED="Logged In, Wallet Uninitialized",e.LOGGED_IN_NEW_DEVICE="Logged In, New Device",e.LOGGED_IN_WALLET_INITIALIZED="Logged In, Wallet Initialized",e))(P||{}),M=new Map,S=class{constructor({clientId:e}){this.isSupported=typeof window<"u"&&!!window.localStorage,this.clientId=e}getItem(e){return n(this,null,function*(){var t;return this.isSupported?window.localStorage.getItem(e):(t=M.get(e))!=null?t:null})}setItem(e,t){return n(this,null,function*(){if(this.isSupported)return window.localStorage.setItem(e,t);M.set(e,t)})}removeItem(e){return n(this,null,function*(){let t=yield this.getItem(e);return this.isSupported&&t?(window.localStorage.removeItem(e),!0):!1})}saveAuthCookie(e){return n(this,null,function*(){yield this.setItem(w(this.clientId),e)})}getAuthCookie(){return n(this,null,function*(){return this.getItem(w(this.clientId))})}removeAuthCookie(){return n(this,null,function*(){return this.removeItem(w(this.clientId))})}saveDeviceShare(e,t){return n(this,null,function*(){yield this.saveWalletUserId(t),yield this.setItem(y(this.clientId,t),e)})}getDeviceShare(){return n(this,null,function*(){let e=yield this.getWalletUserId();return e?this.getItem(y(this.clientId,e)):null})}removeDeviceShare(){return n(this,null,function*(){let e=yield this.getWalletUserId();return e?this.removeItem(y(this.clientId,e)):!1})}getWalletUserId(){return n(this,null,function*(){return this.getItem(I(this.clientId))})}saveWalletUserId(e){return n(this,null,function*(){yield this.setItem(I(this.clientId),e)})}removeWalletUserId(){return n(this,null,function*(){return this.removeItem(I(this.clientId))})}};function v(e){return new Promise(t=>{setTimeout(t,e*1e3)})}var Y={height:"100%",width:"100%",border:"none",backgroundColor:"transparent",colorScheme:"light",position:"fixed",top:"0px",right:"0px",zIndex:"2147483646",display:"none"},E=new Map,X=class{constructor({link:e,iframeId:t,container:i=document.body,iframeStyles:r,onIframeInitialize:s}){this.POLLING_INTERVAL_SECONDS=1.4,this.POST_LOAD_BUFFER_SECONDS=1;let a=document.getElementById(t),o=new URL(e),c="1.2.5";if(o.searchParams.set("sdkVersion",c),!a||a.src!=o.href){if(!a){a=document.createElement("iframe");let l=h(h({},Y),r);Object.assign(a.style,l),a.setAttribute("id",t),a.setAttribute("fetchpriority","high"),i.appendChild(a)}a.src=o.href,a.setAttribute("data-version",c),a.onload=this.onIframeLoadHandler(a,this.POST_LOAD_BUFFER_SECONDS,s)}this.iframe=a}onIframeLoadedInitVariables(){return n(this,null,function*(){return{}})}onIframeLoadHandler(e,t,i){return()=>n(this,null,function*(){yield new Promise((r,s)=>n(this,null,function*(){var a;let o=new MessageChannel;o.port1.onmessage=l=>{let{data:d}=l;return o.port1.close(),d.success?(E.set(e.src,!0),i&&i(),r(!0)):s(new Error(d.error))},yield v(t),(a=e?.contentWindow)==null||a.postMessage({eventType:"initIframe",data:yield this.onIframeLoadedInitVariables()},`${p()}${A}`,[o.port2])}))})}call(e){return n(this,arguments,function*({procedureName:t,params:i,showIframe:r=!1,injectRecoveryCode:s={isInjectRecoveryCode:!1}}){for(;!E.get(this.iframe.src);)yield v(this.POLLING_INTERVAL_SECONDS);return r&&(this.iframe.style.display="block",yield v(.005)),new Promise((a,o)=>{var c;if(s.isInjectRecoveryCode){let d=u=>n(this,null,function*(){var _,W;if(u.origin!==p()||u.data.type!=="paper_getRecoveryCode"||typeof u.data.userWalletId!="string")return;let U=yield(_=s.getRecoveryCode)==null?void 0:_.call(s,u.data.userWalletId);(W=this.iframe.contentWindow)==null||W.postMessage({type:"paper_getRecoveryCode_response",recoveryCode:U},p()),window.removeEventListener("message",d)});window.addEventListener("message",d)}let l=new MessageChannel;l.port1.onmessage=d=>n(this,null,function*(){let{data:u}=d;l.port1.close(),r&&(yield v(.1),this.iframe.style.display="none"),u.success?a(u.data):o(new Error(u.error))}),(c=this.iframe.contentWindow)==null||c.postMessage({eventType:t,data:i},`${p()}${A}`,[l.port2])})})}destroy(){E.delete(this.iframe.src)}},ee=class extends X{constructor({clientId:e,customizationOptions:t}){super({iframeId:ie,link:te({clientId:e,path:A,queryParams:t}).href,container:document.body}),this.clientId=e}onIframeLoadedInitVariables(){return n(this,null,function*(){let e=new S({clientId:this.clientId});return{authCookie:yield e.getAuthCookie(),deviceShareStored:yield e.getDeviceShare(),walletUserId:yield e.getWalletUserId(),clientId:this.clientId}})}};function te({clientId:e,path:t,queryParams:i}){var r;let s=new URL(t,p());if(i)for(let a of Object.keys(i))s.searchParams.set(a,((r=i[a])==null?void 0:r.toString())||"");return s.searchParams.set("clientId",e),s}var ie="paper-embedded-wallet-iframe",T=class{constructor({querier:e,preLogin:t,postLogin:i,clientId:r}){this.LoginQuerier=e,this.preLogin=t,this.postLogin=i,this.clientId=r}sendPaperEmailLoginOtp(e){return n(this,arguments,function*({email:t,recoveryShareManagement:i}){yield this.preLogin();let{isNewUser:r,isNewDevice:s,recoveryShareManagement:a}=yield this.LoginQuerier.call({procedureName:"sendPaperEmailLoginOtp",params:{email:t,recoveryShareManagement:i}});return{isNewUser:r,isNewDevice:s,recoveryShareManagement:a}})}},re=class extends T{constructor(){super(...arguments),this.closeWindow=({isWindowOpenedByFn:e,win:t,closeOpenedWindow:i})=>{e?t?.close():t&&i?i(t):t&&t.close()}}loginWithPaperModal(){return n(this,null,function*(){yield this.preLogin();let e=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:{recoveryShareManagement:"AWS_MANAGED"},showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(e)})}getGoogleLoginUrl(){return n(this,null,function*(){return yield this.LoginQuerier.call({procedureName:"getHeadlessGoogleLoginLink",params:void 0})})}loginWithGoogle(e){return n(this,null,function*(){yield this.preLogin();let t=e?.openedWindow,i=!1;if(t||(t=window.open("","Login","width=350, height=500"),i=!0),!t)throw new Error("Something went wrong opening pop-up");yield this.preLogin();let{loginLink:r}=yield this.getGoogleLoginUrl();t.location.href=r;let s=yield new Promise((a,o)=>{let c=window.setInterval(()=>n(this,null,function*(){t&&t.closed&&(clearInterval(c),window.removeEventListener("message",l),o(new Error("User closed login window")))}),1e3),l=d=>n(this,null,function*(){if(d.origin===p()){if(typeof d.data!="object"){o(new Error("Invalid event data"));return}switch(d.data.eventType){case"userLoginSuccess":{window.removeEventListener("message",l),clearInterval(c),this.closeWindow({isWindowOpenedByFn:i,win:t,closeOpenedWindow:e?.closeOpenedWindow}),d.data.authResult&&a(d.data.authResult);break}case"userLoginFailed":{window.removeEventListener("message",l),clearInterval(c),this.closeWindow({isWindowOpenedByFn:i,win:t,closeOpenedWindow:e?.closeOpenedWindow}),o(new Error(d.data.error));break}case"injectDeveloperClientId":{t?.postMessage({eventType:"injectDeveloperClientIdResult",developerClientId:this.clientId},p());break}}}});window.addEventListener("message",l)});return this.postLogin({storedToken:f(h({},s.storedToken),{shouldStoreCookieString:!0}),walletDetails:f(h({},s.walletDetails),{isIframeStorageEnabled:!1})})})}loginWithPaperEmailOtp(e){return n(this,arguments,function*({email:t}){yield this.preLogin();let i=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:{email:t,recoveryShareManagement:"AWS_MANAGED"},showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(i)})}verifyPaperEmailLoginOtp(e){return n(this,arguments,function*({email:t,otp:i}){let r=yield this.LoginQuerier.call({procedureName:"verifyPaperEmailLoginOtp",params:{email:t,otp:i,recoveryShareManagement:"AWS_MANAGED"},injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(r)})}},ne=class extends T{loginWithPaperModal(e){return n(this,null,function*(){yield this.preLogin();let t=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:void 0,showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0,getRecoveryCode:e?.getRecoveryCode}});return this.postLogin(t)})}loginWithGoogle(e){return n(this,null,function*(){throw new Error("loginWithGoogle is not yet supported in the RecoveryShareManagement.USER_MANAGED flow. Please use RecoveryShareManagement.AWS_MANAGED instead.")})}loginWithPaperEmailOtp(e){return n(this,arguments,function*({email:t,recoveryCode:i}){yield this.preLogin();let r=yield this.LoginQuerier.call({procedureName:"loginWithPaperModal",params:{email:t,recoveryCode:i},showIframe:!0,injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(r)})}verifyPaperEmailLoginOtp(e){return n(this,arguments,function*({email:t,otp:i,recoveryCode:r}){let s=yield this.LoginQuerier.call({procedureName:"verifyPaperEmailLoginOtp",params:{email:t,otp:i,recoveryCode:r},injectRecoveryCode:{isInjectRecoveryCode:!0}});return this.postLogin(s)})}},ae=class{constructor({clientId:e,advancedOptions:t,querier:i,onAuthSuccess:r}){var s;this.clientId=e,this.advancedOptions={recoveryShareManagement:(s=t?.recoveryShareManagement)!=null?s:"AWS_MANAGED"},this.AuthQuerier=i,this.localStorage=new S({clientId:e}),this.onAuthSuccess=r,this.userManagedLogin=new ne({postLogin:a=>n(this,null,function*(){return this.postLogin(a)}),preLogin:()=>n(this,null,function*(){yield this.preLogin()}),querier:i,clientId:e}),this.awsManagedLogin=new re({postLogin:a=>n(this,null,function*(){return this.postLogin(a)}),preLogin:()=>n(this,null,function*(){yield this.preLogin()}),querier:i,clientId:e})}preLogin(){return n(this,null,function*(){yield this.logout()})}postLogin(e){return n(this,arguments,function*({storedToken:t,walletDetails:i}){return t.shouldStoreCookieString&&(yield this.localStorage.saveAuthCookie(t.cookieString)),yield this.onAuthSuccess({storedToken:t,walletDetails:i})})}loginWithJwtAuth(e){return n(this,arguments,function*({token:t,authProvider:i,recoveryCode:r}){yield this.preLogin();let s=yield this.AuthQuerier.call({procedureName:"loginWithJwtAuthCallback",params:{token:t,authProvider:i,recoveryCode:r}});return this.postLogin(s)})}loginWithPaperModal(e){return n(this,null,function*(){return yield this.preLogin(),this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.loginWithPaperModal():this.userManagedLogin.loginWithPaperModal(e)})}loginWithPaperEmailOtp(e){return n(this,null,function*(){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.loginWithPaperEmailOtp({email:e.email}):this.userManagedLogin.loginWithPaperEmailOtp(e)})}loginWithGoogle(e){return n(this,null,function*(){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.loginWithGoogle(e):this.userManagedLogin.loginWithGoogle()})}sendPaperEmailLoginOtp(e){return n(this,arguments,function*({email:t}){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.sendPaperEmailLoginOtp({email:t,recoveryShareManagement:"AWS_MANAGED"}):this.userManagedLogin.sendPaperEmailLoginOtp({email:t})})}verifyPaperEmailLoginOtp(e){return n(this,null,function*(){return this.advancedOptions.recoveryShareManagement==="AWS_MANAGED"?this.awsManagedLogin.verifyPaperEmailLoginOtp(e):this.userManagedLogin.verifyPaperEmailLoginOtp(e)})}logout(){return n(this,null,function*(){let{success:e}=yield this.AuthQuerier.call({procedureName:"logout",params:void 0}),t=yield this.localStorage.removeAuthCookie(),i=yield this.localStorage.removeWalletUserId();return{success:e||t||i}})}},C=class{constructor({chain:e,clientId:t,querier:i}){this.chain=e,this.clientId=t,this.gaslessTransactionQuerier=i}callContract(e){return n(this,arguments,function*({contractAddress:t,methodArgs:i,methodInterface:r}){return yield this.gaslessTransactionQuerier.call({procedureName:"callContract",params:{chain:this.chain,contractAddress:t,method:{args:i,stub:r}}})})}},G=class extends b{constructor({provider:e,clientId:t,querier:i}){var r;super(),this.DEFAULT_ETHEREUM_CHAIN_ID=5,this.clientId=t,this.querier=i,this.endpoint=(r=e.connection)==null?void 0:r.url,j(this,"provider",e)}getAddress(){return n(this,null,function*(){let{address:e}=yield this.querier.call({procedureName:"getAddress",params:void 0});return e})}signMessage(e){return n(this,null,function*(){var t,i,r,s;let a=yield(t=this.provider)==null?void 0:t.getNetwork();a&&a._defaultProvider;let{signedMessage:o}=yield this.querier.call({procedureName:"signMessage",params:{message:e,chainId:(s=(r=yield(i=this.provider)==null?void 0:i.getNetwork())==null?void 0:r.chainId)!=null?s:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return o})}signTransaction(e){return n(this,null,function*(){var t,i,r;let{signedTransaction:s}=yield this.querier.call({procedureName:"signTransaction",params:{transaction:e,chainId:(r=(i=yield(t=this.provider)==null?void 0:t.getNetwork())==null?void 0:i.chainId)!=null?r:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return s})}_signTypedData(e,t,i){return n(this,null,function*(){var r,s,a;let{signedTypedData:o}=yield this.querier.call({procedureName:"signTypedDataV4",params:{domain:e,types:t,message:i,chainId:(a=(s=yield(r=this.provider)==null?void 0:r.getNetwork())==null?void 0:s.chainId)!=null?a:this.DEFAULT_ETHEREUM_CHAIN_ID,rpcEndpoint:this.endpoint}});return o})}connect(e){return new G({clientId:this.clientId,provider:e,querier:this.querier})}},se=class{constructor({clientId:e,chain:t,querier:i}){this.clientId=e,this.chain=t,this.walletManagerQuerier=i,this.gasless=new C({chain:t,clientId:e,querier:i}),this.localStorage=new S({clientId:e})}postWalletSetUp(e){return n(this,arguments,function*({deviceShareStored:t,walletAddress:i,isIframeStorageEnabled:r,walletUserId:s}){return r||(yield this.localStorage.saveDeviceShare(t,s)),{walletAddress:i}})}getUserWalletStatus(){return n(this,null,function*(){let e=yield this.walletManagerQuerier.call({procedureName:"getUserStatus",params:void 0});return e.status==="Logged In, Wallet Initialized"?{status:"Logged In, Wallet Initialized",user:f(h({},e.user),{wallet:this})}:e})}setChain(e){return n(this,arguments,function*({chain:t}){this.chain=t,this.gasless=new C({chain:t,clientId:this.clientId,querier:this.walletManagerQuerier})})}getEthersJsSigner(e){return n(this,null,function*(){var t;return new G({clientId:this.clientId,provider:R((t=e?.rpcEndpoint)!=null?t:k[this.chain]),querier:this.walletManagerQuerier})})}},oe=class{constructor({clientId:e,chain:t,styles:i,advancedOptions:r,onAuthSuccess:s}){this.clientId=e,this.querier=new ee({clientId:e,customizationOptions:i}),this.wallet=new se({clientId:e,chain:t,querier:this.querier}),this.auth=new ae({clientId:e,advancedOptions:h({recoveryShareManagement:"USER_MANAGED"},r??{}),querier:this.querier,onAuthSuccess:a=>n(this,null,function*(){return yield this.wallet.postWalletSetUp(f(h({},a.walletDetails),{walletUserId:a.storedToken.authDetails.userWalletId})),yield this.querier.call({procedureName:"initIframe",params:{deviceShareStored:a.walletDetails.deviceShareStored,clientId:this.clientId,walletUserId:a.storedToken.authDetails.userWalletId,authCookie:a.storedToken.cookieString}}),s?.(a),{user:{status:"Logged In, Wallet Initialized",authDetails:a.storedToken.authDetails,wallet:this.wallet,walletAddress:a.walletDetails.walletAddress}}})})}getUser(){return n(this,null,function*(){let e=yield this.wallet.getUserWalletStatus();switch(e.status){case"Logged In, New Device":case"Logged In, Wallet Uninitialized":return yield this.auth.logout(),this.getUser();case"Logged Out":return{status:"Logged Out"};case"Logged In, Wallet Initialized":return h({status:"Logged In, Wallet Initialized"},e.user)}})}};const le=Object.freeze(Object.defineProperty({__proto__:null,AUTH_TOKEN_LOCAL_STORAGE_NAME:w,AuthProvider:N,DEVICE_SHARE_LOCAL_STORAGE_NAME:y,PaperEmbeddedWalletSdk:oe,RecoveryShareManagement:L,UserStatus:m,UserWalletStatus:P,WALLET_USER_ID_LOCAL_STORAGE_NAME:I},Symbol.toStringTag,{value:"Module"}));class ce extends q{constructor(t){super(),g(this,"id",Q.paper),g(this,"name","Paper Wallet"),g(this,"ready",!0),g(this,"user",null),g(this,"onAccountsChanged",async i=>{i.length===0?await this.onDisconnect():this.emit("change",{account:z(i[0])})}),g(this,"onChainChanged",i=>{const r=x(i),s=this.options.chains.findIndex(a=>a.chainId===r)===-1;this.emit("change",{chain:{id:r,unsupported:s}})}),g(this,"onDisconnect",async()=>{this.emit("disconnect")}),this.options=t}getPaperSDK(){return this.paper||(this.paper=new Promise(async(t,i)=>{const r=this.options.advancedOptions?.recoveryShareManagement;try{const{PaperEmbeddedWalletSdk:s}=await H(async()=>{const{PaperEmbeddedWalletSdk:c}=await Promise.resolve().then(()=>le);return{PaperEmbeddedWalletSdk:c}},void 0),a={AWS_MANAGED:L.AWS_MANAGED,USER_MANAGED:L.USER_MANAGED},o=r?a[r]:void 0;t(new s({advancedOptions:{recoveryShareManagement:o},clientId:this.options.clientId,chain:"Ethereum",styles:this.options.styles,onAuthSuccess:this.options.onAuthSuccess}))}catch(s){i(s)}})),this.paper}async connect(t){const i=await this.getPaperSDK();if(!i)throw new Error("Paper SDK not initialized");const r=await i.getUser();switch(r.status){case m.LOGGED_OUT:{let s;if(t?.googleLogin){const a=t.googleLogin;s=await i.auth.loginWithGoogle(typeof a=="object"?a:void 0)}else t?.email&&t?.otp?s=await i.auth.verifyPaperEmailLoginOtp({email:t.email,otp:t.otp,recoveryCode:t.recoveryCode}):t?.email?s=await i.auth.loginWithPaperEmailOtp({email:t.email}):s=await i.auth.loginWithPaperModal();this.user=s.user;break}case m.LOGGED_IN_WALLET_INITIALIZED:{typeof t?.googleLogin=="object"&&t.googleLogin.closeOpenedWindow&&t.googleLogin.openedWindow&&t.googleLogin.closeOpenedWindow(t.googleLogin.openedWindow),this.user=r;break}}if(!this.user)throw new Error("Error connecting User");return t?.chainId&&this.switchChain(t.chainId),this.setupListeners(),this.getAddress()}async disconnect(){await(await this.paper)?.auth.logout(),this._signer=void 0,this.user=null}async getAddress(){return(await this.getSigner()).getAddress()}async isConnected(){try{return!!await this.getAddress()}catch{return!1}}async getProvider(){const t=await this.getSigner();if(!t.provider)throw new Error("Provider not found");return t.provider}async getSigner(){if(this._signer)return this._signer;if(!this.user){const r=await(await this.getPaperSDK()).getUser();switch(r.status){case m.LOGGED_IN_WALLET_INITIALIZED:{this.user=r;break}}}const t=await this.user?.wallet.getEthersJsSigner({rpcEndpoint:this.options.chain.rpc[0]||""});if(!t)throw new Error("Signer not found");return this._signer=t,t}async isAuthorized(){return!1}async switchChain(t){const i=this.options.chains.find(r=>r.chainId===t);if(!i)throw new Error("Chain not configured");await this.user?.wallet.setChain({chain:"Ethereum"}),this._signer=await this.user?.wallet.getEthersJsSigner({rpcEndpoint:i.rpc[0]||""}),this.emit("change",{chain:{id:t,unsupported:!1}})}async setupListeners(){const t=await this.getProvider();t.on&&(t.on("accountsChanged",this.onAccountsChanged),t.on("chainChanged",this.onChainChanged),t.on("disconnect",this.onDisconnect))}updateChains(t){this.options.chains=t}async getEmail(){if(await this.getProvider(),!this.user)throw new Error("No user found, Paper Wallet is not connected");return this.user.authDetails.email}}export{ce as PaperWalletConnector};
